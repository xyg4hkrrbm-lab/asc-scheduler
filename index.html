<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=2, user-scalable=yes">
  <title>ASC Weekly Scheduler (Surgery + Tech Split)</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e8eefc;
      --muted:#b7c3e6;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;

      --border: rgba(35,52,85,.85);
      --panel: rgba(15,27,51,.88);
      --panel2: rgba(19,32,68,.90);

      --c-ortho: rgba(122,162,255,.18);
      --c-pain: rgba(255,193,7,.16);
      --c-eyes: rgba(99,230,190,.14);
      --c-pods: rgba(186,104,200,.16);
      --c-gyn: rgba(255,138,101,.16);
      --c-ent: rgba(144,202,249,.16);
      --c-other: rgba(255,255,255,.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, rgba(99,230,190,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    header{
      position: sticky; top: 0; z-index: 10;
      background: rgba(11,18,32,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(35,52,85,.7);
    }
    .wrap{ max-width: 1500px; margin: 0 auto; padding: 14px 16px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap; }
    .title{ display:flex; align-items:baseline; gap: 10px; flex-wrap: wrap; }
    .title h1{ font-size: 18px; margin: 0; letter-spacing: .2px; }
    .title small{ color: var(--muted); }

    .controls{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }

    button, select, input, textarea{ font: inherit; color: var(--text); }
    button{
      border: 1px solid rgba(35,52,85,.9);
      background: linear-gradient(180deg, rgba(19,32,68,.9), rgba(15,27,51,.9));
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    button:hover{ border-color: rgba(122,162,255,.55); }
    button.primary{ border-color: rgba(122,162,255,.55); }
    button.danger{ border-color: rgba(255,107,107,.45); }
    button.ghost{ box-shadow:none; background: transparent; border-color: rgba(35,52,85,.7); }
    button.smallBtn{
      padding: 7px 9px;
      border-radius: 10px;
      box-shadow:none;
      font-size: 12.5px;
      white-space: nowrap;
    }
    button.pill{
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow:none;
      font-size: 12.5px;
    }

    .hint{ color: var(--muted); font-size: 13px; padding-top: 10px; line-height:1.35; }
    main{ padding: 14px 16px 36px; }

    #captureArea{
      border-radius: 18px;
      padding: 8px;
      background: rgba(0,0,0,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(250px, 1fr));
      gap: 12px;
      align-items:stretch;
    }

    .day{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display:flex;
      flex-direction:column;
      min-height: 480px;
      height: calc(100vh - 190px);
    }

    .dayHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(35,52,85,.8);
      background: linear-gradient(180deg, var(--panel2), rgba(15,27,51,.9));
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .dayHeader h2{ margin:0; font-size: 14.5px; letter-spacing:.2px; }
    .dayHeader .date{ margin-top: 3px; color: var(--muted); font-size: 12.5px; }

    .dayActions{ display:flex; align-items:center; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }

    .dayBody{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }

    .lane{
      flex: 1 1 50%;
      min-height: 0;
      display:flex;
      flex-direction:column;
      border-top: 1px solid rgba(35,52,85,.45);
    }
    .lane:first-child{ border-top: none; }

    .laneHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px 8px;
      background: rgba(11,18,32,.20);
      border-bottom: 1px solid rgba(35,52,85,.35);
    }
    .laneHead .laneTitle{
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.2px;
    }

    .cases{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:auto;
      min-height: 0;
    }

    .caseCard{
      border: 1px solid rgba(35,52,85,.85);
      border-radius: 14px;
      background: rgba(11,18,32,.42);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      cursor:pointer;
      min-width: 0;
    }
    .caseCard:hover{ border-color: rgba(122,162,255,.55); }

    .t-ortho{ background: var(--c-ortho); }
    .t-pain{ background: var(--c-pain); }
    .t-eyes{ background: var(--c-eyes); }
    .t-pods{ background: var(--c-pods); }
    .t-gyn{ background: var(--c-gyn); }
    .t-ent{ background: var(--c-ent); }
    .t-other{ background: var(--c-other); }

    .timeStack{
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 0;
    }
    .timePill{

      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:flex-start;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      min-width: 0;
    }
    .timeTop{
      width: 100%;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      min-width: 0;
    }
    .timePill .label{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .timePill .val{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .timePill.xray{
      border-color: rgba(255,80,80,.55);
      background: rgba(255,80,80,.18);
    }
    .timePill.xray .label{
      color: #ffd6d6;
    }
    .timePill.xray .val,
    .timePill.xray .sub{
      color: #fff;
    }

    .timePill .sub{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: normal;
      word-break: break-word;
      line-height: 1.15;
      opacity: .98;
    }

    .timeTop{
      flex-wrap: wrap;
      row-gap: 2px;
    }
    .timePill .label{
      max-width: 100%;
    }
    .timePill .val{
      margin-left: auto;
      font-size: clamp(14px, 1.1vw, 16px);
      line-height: 1.1;
    }
    .timePill.xray{
      border-color: rgba(255,80,80,.55);
      background: rgba(255,80,80,.18);
    }
    .timePill.xray .label{
      color: #ffd6d6;
    }
    .timePill.xray .val,
    .timePill.xray .sub{
      color: #fff;
    }

    .timePill .sub{
      font-size: clamp(14px, 1.1vw, 16px);
    }
    .physLine{
      white-space: normal;
      word-break: break-word;
    }
    .specTag{
      max-width: 100%;
      white-space: normal;
      word-break: break-word;
    }
    .dayHeader{
      flex-wrap: wrap;
    }
    .dayActions{
      width: 100%;
      justify-content: flex-start;
    }

    .specTag{
      margin-left:auto;
      font-size: 11.5px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      white-space: nowrap;
      height: fit-content;
      margin-top: 2px;
      opacity: .95;
    }

    .physLine{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }
    .small{ font-size: 12.5px; color: var(--muted); }

    .modalBackdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50;
    }
    .modalBackdrop.open{ display:flex; }
    .modal{
      width: min(920px, 100%);
      background: rgba(15,27,51,.96);
      border: 1px solid rgba(35,52,85,.95);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(19,32,68,.92), rgba(15,27,51,.92));
      border-bottom: 1px solid rgba(35,52,85,.8);
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
    }
    .modalHead h3{ margin:0; font-size: 14.5px; }
    .modalBody{
      padding: 14px 16px 16px;
      display:grid; grid-template-columns: 1fr 1fr; gap: 10px 12px;
    }
    .field{ display:flex; flex-direction:column; gap: 6px; }
    .field label{ color: var(--muted); font-size: 12.5px; }
    .field input, .field select, .field textarea{
      background: rgba(11,18,32,.55);
      border: 1px solid rgba(35,52,85,.9);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      color: var(--text);
    }
    .field textarea{ min-height: 86px; resize: vertical; grid-column: 1 / -1; }

    .toggleRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border: 1px solid rgba(35,52,85,.75);
      border-radius: 14px;
      background: rgba(11,18,32,.22);
      grid-column: 1 / -1;
    }
    .toggleRow input[type="checkbox"]{ width:18px; height:18px; }

    .scrubList{
      grid-column: 1 / -1;
      border: 1px solid rgba(35,52,85,.75);
      border-radius: 14px;
      padding: 10px;
      background: rgba(11,18,32,.30);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .scrubRow{
      display:grid;
      grid-template-columns: 1.2fr 1fr 40px;
      gap: 10px;
      align-items:center;
    }
    .scrubRow .removeBtn{
      border-color: rgba(255,107,107,.45);
      background: rgba(255,107,107,.10);
      box-shadow:none;
      height: 40px;
      width: 40px;
      border-radius: 12px;
      font-weight: 900;
    }

    .scrubRow select,
    .scrubRow input{
      background: rgba(11,18,32,.55);
      border: 1px solid rgba(35,52,85,.9);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      color: var(--text);
    }
    .scrubRow select option{
      background: rgba(11,18,32,.98);
      color: var(--text);
    }

    .modalFoot{
      padding: 12px 16px 16px;
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
      border-top: 1px solid rgba(35,52,85,.75);
    }
    .leftBtns, .rightBtns{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }

    @media (max-width: 1200px){
      .grid{ grid-template-columns: repeat(2, minmax(250px, 1fr)); }
      .day{ height: auto; min-height: 520px; }
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      .day{ height: auto; min-height: 520px; }
      .modalBody{ grid-template-columns: 1fr; }
      .scrubRow{ grid-template-columns: 1fr; }
      .scrubRow .removeBtn{ width:100%; }
    }

    @media print{
      header, .hint, .controls, .dayActions { display:none !important; }
      body{ background: #fff; color:#000; }
      main{ padding: 0; }
      .wrap{ max-width: none; padding: 0; }
      #captureArea{ padding: 0; background: transparent; }
      .grid{ gap: 8px; grid-template-columns: repeat(6, 1fr); }
      .day{ background: #fff; border: 1px solid #bbb; box-shadow:none; height:auto; min-height:auto; }
      .dayHeader{ background: #f2f2f2; border-bottom: 1px solid #bbb; }
      .dayHeader h2, .dayHeader .date{ color:#000; }
      .laneHead{ background:#f7f7f7; border-bottom:1px solid #ddd; }
      .laneHead .laneTitle{ color:#000; }
      .caseCard{ background: #fff; border: 1px solid #d0d0d0; box-shadow:none; }
      .specTag{ border: 1px solid #bbb; color:#000; }
      .physLine, .small{ color:#333; }
      .timePill{
 border: 1px solid #cfcfcf; background:#f7f7f7; }
      .timePill .label{ color:#444; }
      .timePill .val, .timePill.xray{
      border-color: rgba(255,80,80,.55);
      background: rgba(255,80,80,.18);
    }
    .timePill.xray .label{
      color: #ffd6d6;
    }
    .timePill.xray .val,
    .timePill.xray .sub{
      color: #fff;
    }

    .timePill .sub{ color:#000; }
      @page { size: landscape; margin: 0.35in; }
    }
  </style>

<style>
/* ===== iPad Pro 13-inch: Exact Full-Screen Fit ===== */
html, body {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

header {
  max-height: 14vh;
}

/* Force 7 equal columns */
.week-grid {
  display: grid !important;
  grid-template-columns: repeat(7, minmax(0, 1fr)) !important;
  width: 100%;
  gap: 8px;
  overflow: hidden;
}

.day-column {
  min-width: 0 !important;
  width: 100% !important;
  overflow: hidden;
}

.main-container, .schedule-container {
  height: calc(100vh - 14vh);
  overflow: hidden;
}

.card {
  font-size: 0.82em;
}

button {
  padding: 5px 8px;
  font-size: 0.85em;
}
</style>

<style>
/* ===== FINAL iPad Pro Fix: Native Pinch Zoom Enabled ===== */

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  overflow: visible !important; /* allow Safari zoom */
  -webkit-text-size-adjust: 100%;
}

/* Keep strict 7-day grid */
.week-grid {
  display: grid !important;
  grid-template-columns: repeat(7, minmax(0, 1fr)) !important;
  width: 100%;
}

/* Prevent columns from forcing overflow */
.day-column {
  min-width: 0 !important;
  width: 100% !important;
}

/* Header height cap */
header {
  max-height: 14vh;
}

/* Avoid internal scroll traps */
.main-container,
.schedule-container {
  overflow: visible !important;
}
</style>

<style>
/* ===== ULTRA-DENSE MODE: FIT 10 SURGERY + 10 TECH CARDS ===== */

header {
  max-height: 12vh !important;
}

.main-container,
.schedule-container {
  height: calc(100vh - 12vh) !important;
  overflow: hidden !important;
}

.day-column {
  display: flex;
  flex-direction: column;
  min-width: 0 !important;
}

.lane {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.card {
  padding: 2px 4px !important;
  margin: 2px 0 !important;
  font-size: 0.65em !important;
  line-height: 1.1 !important;
}

.card strong {
  font-size: 0.7em !important;
}

button {
  padding: 3px 6px !important;
  font-size: 0.7em !important;
}

*::-webkit-scrollbar {
  display: none;
}
</style>

<style>
/* === COLLAPSIBLE CARD MODE === */
.caseCard.collapsed {
  padding: 4px 6px !important;
}

.caseCard.collapsed .timeStack > *:not(.miniLine),
.caseCard.collapsed .small,
.caseCard.collapsed .specTag {
  display: none !important;
}

.miniLine {
  display: none;
  font-size: 12px;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.caseCard.collapsed .miniLine {
  display: block;
}
</style>

</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>ASC Weekly Scheduler</h1>
        <small id="weekSmall"></small>
      </div>

      <div class="controls">
        <button class="ghost" id="prevWeekBtn" type="button">◀︎ Week</button>
        <button class="ghost" id="todayWeekBtn" type="button">This Week</button>
        <button class="ghost" id="nextWeekBtn" type="button">Week ▶︎</button>

        <button class="ghost" id="copyPrevBtn" type="button">Copy Prev Week</button>
        <button class="primary" id="exportPngBtn" type="button">Export PNG (Screenshot)</button>
        <button class="ghost" id="printBtn" type="button">Print / Save PDF</button>
        <button class="danger" id="clearWeekBtn" type="button">Clear Week</button>
      </div>
    </div>

    <div class="hint">
      Each day is split horizontally: <b>Surgery</b> on top, <b>Tech</b> on bottom. Tech cards focus on Scrub/X-Ray start times.
      Specialty/surgeon are optional on Surgery cards. X-Ray section on Tech cards can be toggled on/off.
    </div>
  </div>
</header>

<main>
  <div class="wrap" id="captureArea">
    <div class="grid" id="grid"></div>
  </div>
</main>

<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modalHead">
      <h3 id="modalTitle">Add Card</h3>
      <button class="ghost" id="closeModalBtn" type="button" aria-label="Close">✕</button>
    </div>

    <div class="modalBody">
      <div class="field">
        <label for="cardDay">Day</label>
        <select id="cardDay"></select>
      </div>

      <div class="field">
        <label for="cardType">Card type</label>
        <select id="cardType">
          <option value="surgery">Surgery</option>
          <option value="tech">Tech</option>
        </select>
      </div>

      <div class="field" data-section="surgery">
        <label for="surgStart">Surgery start time</label>
        <select id="surgStart"></select>
      </div>

      <div class="field" data-section="surgery">
        <label for="caseSpec">Specialty (optional)</label>
        <select id="caseSpec"></select>
      </div>

      <div class="field" data-section="surgery">
        <label for="caseSurgeonSelect">Surgeon (optional)</label>
        <select id="caseSurgeonSelect"></select>
      </div>

      <div class="field" id="surgeonOtherField" data-section="surgery" style="display:none;">
        <label for="caseSurgeonOther">Surgeon (Other)</label>
        <input id="caseSurgeonOther" type="text" placeholder="Type surgeon name" />
      </div>

      <div class="field" data-section="surgery">
        <label for="surgNotes">Notes (optional)</label>
        <textarea id="surgNotes" placeholder="Implants, trays, special equipment, etc."></textarea>
      </div>

      <div class="toggleRow" data-section="tech">
        <input id="useScrub" type="checkbox" checked />
        <label for="useScrub" style="cursor:pointer;color:var(--text);font-weight:800;">Include Scrub for this Tech card</label>
      </div>
      <div class="field" data-section="tech" data-scrub="1">
        <label for="scrubStart">Scrub start time</label>
        <select id="scrubStart"></select>
      </div>

      <div class="scrubList" data-section="tech" data-scrub="1">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div class="small" style="font-weight:800;color:var(--text);">Scrub Techs (multiple, optional)</div>
          <button class="smallBtn" id="addScrubBtn" type="button">+ Add Scrub Tech</button>
        </div>
        <div class="small" style="margin-top:-6px;">You can leave this empty and fill in later.</div>
        <div id="scrubRows"></div>
      </div>

      <div class="toggleRow" data-section="tech">
        <input id="useXray" type="checkbox" />
        <label for="useXray" style="cursor:pointer;color:var(--text);font-weight:800;">Include X-Ray for this Tech card</label>
      </div>

      <div class="field" data-section="tech" data-xray="1">
        <label for="xrayStart">X-Ray start time</label>
        <select id="xrayStart"></select>
      </div>

      <div class="field" data-section="tech" data-xray="1">
        <label for="caseXraySelect">X-Ray Tech</label>
        <select id="caseXraySelect"></select>
      </div>

      <div class="field" id="xrayOtherField" data-section="tech" data-xray="1" style="display:none;">
        <label for="caseXrayOther">X-Ray Tech (Other)</label>
        <input id="caseXrayOther" type="text" placeholder="Type x-ray tech name" />
      </div>

      <div class="field" data-section="tech">
        <label for="techNotes">Notes (optional)</label>
        <textarea id="techNotes" placeholder="Tech notes (optional)"></textarea>
      </div>
    </div>

    <div class="modalFoot">
      <div class="leftBtns">
        <button class="danger" id="deleteBtn" type="button" style="display:none;">Delete</button>
        <span class="small" id="saveStatus"></span>
      </div>
      <div class="rightBtns">
        <button class="ghost" id="cancelBtn" type="button">Cancel</button>
        <button class="primary" id="saveBtn" type="button">Save</button>
      </div>
    </div>
  </div>
</div>

<style>
/* === COLLAPSED CARD FIX === */
.caseCard.collapsed {
  padding: 4px 6px !important;
}

.caseCard .collapsed-line {
  display: none;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.caseCard.collapsed .collapsed-line {
  display: block;
}

.caseCard.collapsed .details {
  display: none !important;
}
</style>

<script>
// ===== SAFETY PATCH FOR PRODUCTION =====
if (typeof window.openCardModal !== 'function') {
  window.openCardModal = function(card){
    if (typeof window.openCardEditor === 'function') {
      window.openCardEditor({ mode: 'edit', card });
    } else {
      console.warn("Editor not available");
    }
  };
}
</script>

<style>
/* ===== FINAL COLLAPSIBLE CARD SYSTEM ===== */
.caseCard {
  transition: all .15s ease;
}
.caseCard[data-collapsed="true"] {
  padding: 4px 6px !important;
  font-size: 12px;
}
.caseCard[data-collapsed="true"] * {
  display: none !important;
}
.caseCard[data-collapsed="true"] .collapsed-summary {
  display: block !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 700;
}
</style>

<script>
/* ===== FINAL TAP / LONG-PRESS HANDLER (PRODUCTION SAFE) ===== */
(function(){
  const LONG_PRESS_MS = 500;
  let timer = null;
  let longPress = false;

  function ensureSummary(card){
    let sum = card.querySelector(".collapsed-summary");
    if(sum) return;

    const time =
      card.querySelector(".val")?.innerText ||
      card.querySelector(".time")?.innerText || "";
    const name =
      card.querySelector(".physLine")?.innerText ||
      card.querySelector(".sub")?.innerText ||
      "Case";

    sum = document.createElement("div");
    sum.className = "collapsed-summary";
    sum.textContent = time ? `${time} — ${name}` : name;
    card.prepend(sum);
  }

  document.addEventListener("pointerdown", e => {
    const card = e.target.closest(".caseCard");
    if(!card) return;

    longPress = false;
    timer = setTimeout(() => {
      longPress = true;
      timer = null;
      card.dataset.collapsed = "false";
      if(typeof openModalForEdit === "function" && card.__cardId){
        openModalForEdit(card.__cardId);
      }
    }, LONG_PRESS_MS);
  });

  ["pointerup","pointercancel","pointerleave"].forEach(ev =>
    document.addEventListener(ev, () => {
      if(timer){ clearTimeout(timer); timer = null; }
    })
  );

  document.addEventListener("click", e => {
    const card = e.target.closest(".caseCard");
    if(!card || longPress) return;

    ensureSummary(card);
    const isCollapsed = card.dataset.collapsed === "true";
    card.dataset.collapsed = isCollapsed ? "false" : "true";
  });
})();
</script>

</body>
</html>
