<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=2, user-scalable=yes">
  <title>ASC Weekly Scheduler (Surgery + Tech Split)</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e8eefc;
      --muted:#b7c3e6;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;

      --border: rgba(35,52,85,.85);
      --panel: rgba(15,27,51,.88);
      --panel2: rgba(19,32,68,.90);

      --c-ortho: rgba(122,162,255,.18);
      --c-pain: rgba(255,193,7,.16);
      --c-eyes: rgba(99,230,190,.14);
      --c-pods: rgba(186,104,200,.16);
      --c-gyn: rgba(255,138,101,.16);
      --c-ent: rgba(144,202,249,.16);
      --c-other: rgba(255,255,255,.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, rgba(99,230,190,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    header{
      position: sticky; top: 0; z-index: 10;
      background: rgba(11,18,32,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(35,52,85,.7);
    }
    .wrap{ max-width: 1500px; margin: 0 auto; padding: 14px 16px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap; }
    .title{ display:flex; align-items:baseline; gap: 10px; flex-wrap: wrap; }
    .title h1{ font-size: 18px; margin: 0; letter-spacing: .2px; }
    .title small{ color: var(--muted); }

    .controls{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }

    button, select, input, textarea{ font: inherit; color: var(--text); }
    button{
      border: 1px solid rgba(35,52,85,.9);
      background: linear-gradient(180deg, rgba(19,32,68,.9), rgba(15,27,51,.9));
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    button:hover{ border-color: rgba(122,162,255,.55); }
    button.primary{ border-color: rgba(122,162,255,.55); }
    button.danger{ border-color: rgba(255,107,107,.45); }
    button.ghost{ box-shadow:none; background: transparent; border-color: rgba(35,52,85,.7); }
    button.smallBtn{
      padding: 7px 9px;
      border-radius: 10px;
      box-shadow:none;
      font-size: 12.5px;
      white-space: nowrap;
    }
    button.pill{
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow:none;
      font-size: 12.5px;
    }

    .hint{ color: var(--muted); font-size: 13px; padding-top: 10px; line-height:1.35; }
    main{ padding: 14px 16px 36px; }

    #captureArea{
      border-radius: 18px;
      padding: 8px;
      background: rgba(0,0,0,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(250px, 1fr));
      gap: 12px;
      align-items:stretch;
    }

    .day{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display:flex;
      flex-direction:column;
      min-height: 480px;
      height: calc(100vh - 190px);
    }

    .dayHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(35,52,85,.8);
      background: linear-gradient(180deg, var(--panel2), rgba(15,27,51,.9));
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .dayHeader h2{ margin:0; font-size: 14.5px; letter-spacing:.2px; }
    .dayHeader .date{ margin-top: 3px; color: var(--muted); font-size: 12.5px; }

    .dayActions{ display:flex; align-items:center; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }

    .dayBody{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }

    .lane{
      flex: 1 1 50%;
      min-height: 0;
      display:flex;
      flex-direction:column;
      border-top: 1px solid rgba(35,52,85,.45);
    }
    .lane:first-child{ border-top: none; }

    .laneHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px 8px;
      background: rgba(11,18,32,.20);
      border-bottom: 1px solid rgba(35,52,85,.35);
    }
    .laneHead .laneTitle{
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.2px;
    }

    .cases{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:auto;
      min-height: 0;
    }

    .caseCard{
      border: 1px solid rgba(35,52,85,.85);
      border-radius: 14px;
      background: rgba(11,18,32,.42);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      cursor:pointer;
      min-width: 0;
    }
    .caseCard:hover{ border-color: rgba(122,162,255,.55); }

    .t-ortho{ background: var(--c-ortho); }
    .t-pain{ background: var(--c-pain); }
    .t-eyes{ background: var(--c-eyes); }
    .t-pods{ background: var(--c-pods); }
    .t-gyn{ background: var(--c-gyn); }
    .t-ent{ background: var(--c-ent); }
    .t-other{ background: var(--c-other); }

    .timeStack{
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 0;
    }
    .timePill{

      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:flex-start;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      min-width: 0;
    }
    .timeTop{
      width: 100%;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      min-width: 0;
    }
    .timePill .label{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .timePill .val{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .timePill.xray{
      border-color: rgba(255,80,80,.55);
      background: rgba(255,80,80,.18);
    }
    .timePill.xray .label{
      color: #ffd6d6;
    }
    .timePill.xray .val,
    .timePill.xray .sub{
      color: #fff;
    }

    .timePill .sub{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: normal;
      word-break: break-word;
      line-height: 1.15;
      opacity: .98;
    }

    .timeTop{
      flex-wrap: wrap;
      row-gap: 2px;
    }
    .timePill .label{
      max-width: 100%;
    }
    .timePill .val{
      margin-left: auto;
      font-size: clamp(14px, 1.1vw, 16px);
      line-height: 1.1;
    }
    .timePill.xray{
      border-color: rgba(255,80,80,.55);
      background: rgba(255,80,80,.18);
    }
    .timePill.xray .label{
      color: #ffd6d6;
    }
    .timePill.xray .val,
    .timePill.xray .sub{
      color: #fff;
    }

    .timePill .sub{
      font-size: clamp(14px, 1.1vw, 16px);
    }
    .physLine{
      white-space: normal;
      word-break: break-word;
    }
    .specTag{
      max-width: 100%;
      white-space: normal;
      word-break: break-word;
    }
    .dayHeader{
      flex-wrap: wrap;
    }
    .dayActions{
      width: 100%;
      justify-content: flex-start;
    }


    .specTag{
      margin-left:auto;
      font-size: 11.5px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      white-space: nowrap;
      height: fit-content;
      margin-top: 2px;
      opacity: .95;
    }

    .physLine{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }
    .small{ font-size: 12.5px; color: var(--muted); }

    .modalBackdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50;
    }
    .modalBackdrop.open{ display:flex; }
    .modal{
      width: min(920px, 100%);
      background: rgba(15,27,51,.96);
      border: 1px solid rgba(35,52,85,.95);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(19,32,68,.92), rgba(15,27,51,.92));
      border-bottom: 1px solid rgba(35,52,85,.8);
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
    }
    .modalHead h3{ margin:0; font-size: 14.5px; }
    .modalBody{
      padding: 14px 16px 16px;
      display:grid; grid-template-columns: 1fr 1fr; gap: 10px 12px;
    }
    .field{ display:flex; flex-direction:column; gap: 6px; }
    .field label{ color: var(--muted); font-size: 12.5px; }
    .field input, .field select, .field textarea{
      background: rgba(11,18,32,.55);
      border: 1px solid rgba(35,52,85,.9);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      color: var(--text);
    }
    .field textarea{ min-height: 86px; resize: vertical; grid-column: 1 / -1; }

    .toggleRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border: 1px solid rgba(35,52,85,.75);
      border-radius: 14px;
      background: rgba(11,18,32,.22);
      grid-column: 1 / -1;
    }
    .toggleRow input[type="checkbox"]{ width:18px; height:18px; }

    .scrubList{
      grid-column: 1 / -1;
      border: 1px solid rgba(35,52,85,.75);
      border-radius: 14px;
      padding: 10px;
      background: rgba(11,18,32,.30);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .scrubRow{
      display:grid;
      grid-template-columns: 1.2fr 1fr 40px;
      gap: 10px;
      align-items:center;
    }
    .scrubRow .removeBtn{
      border-color: rgba(255,107,107,.45);
      background: rgba(255,107,107,.10);
      box-shadow:none;
      height: 40px;
      width: 40px;
      border-radius: 12px;
      font-weight: 900;
    }

    .scrubRow select,
    .scrubRow input{
      background: rgba(11,18,32,.55);
      border: 1px solid rgba(35,52,85,.9);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      color: var(--text);
    }
    .scrubRow select option{
      background: rgba(11,18,32,.98);
      color: var(--text);
    }

    .modalFoot{
      padding: 12px 16px 16px;
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
      border-top: 1px solid rgba(35,52,85,.75);
    }
    .leftBtns, .rightBtns{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }

    @media (max-width: 1200px){
      .grid{ grid-template-columns: repeat(2, minmax(250px, 1fr)); }
      .day{ height: auto; min-height: 520px; }
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      .day{ height: auto; min-height: 520px; }
      .modalBody{ grid-template-columns: 1fr; }
      .scrubRow{ grid-template-columns: 1fr; }
      .scrubRow .removeBtn{ width:100%; }
    }

    @media print{
      header, .hint, .controls, .dayActions { display:none !important; }
      body{ background: #fff; color:#000; }
      main{ padding: 0; }
      .wrap{ max-width: none; padding: 0; }
      #captureArea{ padding: 0; background: transparent; }
      .grid{ gap: 8px; grid-template-columns: repeat(6, 1fr); }
      .day{ background: #fff; border: 1px solid #bbb; box-shadow:none; height:auto; min-height:auto; }
      .dayHeader{ background: #f2f2f2; border-bottom: 1px solid #bbb; }
      .dayHeader h2, .dayHeader .date{ color:#000; }
      .laneHead{ background:#f7f7f7; border-bottom:1px solid #ddd; }
      .laneHead .laneTitle{ color:#000; }
      .caseCard{ background: #fff; border: 1px solid #d0d0d0; box-shadow:none; }
      .specTag{ border: 1px solid #bbb; color:#000; }
      .physLine, .small{ color:#333; }
      .timePill{
 border: 1px solid #cfcfcf; background:#f7f7f7; }
      .timePill .label{ color:#444; }
      .timePill .val, .timePill.xray{
      border-color: rgba(255,80,80,.55);
      background: rgba(255,80,80,.18);
    }
    .timePill.xray .label{
      color: #ffd6d6;
    }
    .timePill.xray .val,
    .timePill.xray .sub{
      color: #fff;
    }

    .timePill .sub{ color:#000; }
      @page { size: landscape; margin: 0.35in; }
    }
  </style>

<style>
/* ===== iPad Pro 13-inch: Exact Full-Screen Fit ===== */
html, body {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

header {
  max-height: 14vh;
}

/* Force 7 equal columns */
.week-grid {
  display: grid !important;
  grid-template-columns: repeat(7, minmax(0, 1fr)) !important;
  width: 100%;
  gap: 8px;
  overflow: hidden;
}

.day-column {
  min-width: 0 !important;
  width: 100% !important;
  overflow: hidden;
}

.main-container, .schedule-container {
  height: calc(100vh - 14vh);
  overflow: hidden;
}

.card {
  font-size: 0.82em;
}

button {
  padding: 5px 8px;
  font-size: 0.85em;
}
</style>


<style>
/* ===== FINAL iPad Pro Fix: Native Pinch Zoom Enabled ===== */

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  overflow: visible !important; /* allow Safari zoom */
  -webkit-text-size-adjust: 100%;
}

/* Keep strict 7-day grid */
.week-grid {
  display: grid !important;
  grid-template-columns: repeat(7, minmax(0, 1fr)) !important;
  width: 100%;
}

/* Prevent columns from forcing overflow */
.day-column {
  min-width: 0 !important;
  width: 100% !important;
}

/* Header height cap */
header {
  max-height: 14vh;
}

/* Avoid internal scroll traps */
.main-container,
.schedule-container {
  overflow: visible !important;
}
</style>


<style>
/* ===== ULTRA-DENSE MODE: FIT 10 SURGERY + 10 TECH CARDS ===== */

header {
  max-height: 12vh !important;
}

.main-container,
.schedule-container {
  height: calc(100vh - 12vh) !important;
  overflow: hidden !important;
}

.day-column {
  display: flex;
  flex-direction: column;
  min-width: 0 !important;
}

.lane {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.card {
  padding: 2px 4px !important;
  margin: 2px 0 !important;
  font-size: 0.65em !important;
  line-height: 1.1 !important;
}

.card strong {
  font-size: 0.7em !important;
}

button {
  padding: 3px 6px !important;
  font-size: 0.7em !important;
}

*::-webkit-scrollbar {
  display: none;
}
</style>


<style>
/* === COLLAPSIBLE CARD MODE === */
.caseCard.collapsed {
  padding: 4px 6px !important;
}

.caseCard.collapsed .timeStack > *:not(.miniLine),
.caseCard.collapsed .small,
.caseCard.collapsed .specTag {
  display: none !important;
}

.miniLine {
  display: none;
  font-size: 12px;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.caseCard.collapsed .miniLine {
  display: block;
}
</style>

</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>ASC Weekly Scheduler</h1>
        <small id="weekSmall"></small>
      </div>

      <div class="controls">
        <button class="ghost" id="prevWeekBtn" type="button">◀︎ Week</button>
        <button class="ghost" id="todayWeekBtn" type="button">This Week</button>
        <button class="ghost" id="nextWeekBtn" type="button">Week ▶︎</button>

        <button class="ghost" id="copyPrevBtn" type="button">Copy Prev Week</button>
        <button class="primary" id="exportPngBtn" type="button">Export PNG (Screenshot)</button>
        <button class="ghost" id="printBtn" type="button">Print / Save PDF</button>
        <button class="danger" id="clearWeekBtn" type="button">Clear Week</button>
      </div>
    </div>

    <div class="hint">
      Each day is split horizontally: <b>Surgery</b> on top, <b>Tech</b> on bottom. Tech cards focus on Scrub/X-Ray start times.
      Specialty/surgeon are optional on Surgery cards. X-Ray section on Tech cards can be toggled on/off.
    </div>
  </div>
</header>

<main>
  <div class="wrap" id="captureArea">
    <div class="grid" id="grid"></div>
  </div>
</main>

<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modalHead">
      <h3 id="modalTitle">Add Card</h3>
      <button class="ghost" id="closeModalBtn" type="button" aria-label="Close">✕</button>
    </div>

    <div class="modalBody">
      <div class="field">
        <label for="cardDay">Day</label>
        <select id="cardDay"></select>
      </div>

      <div class="field">
        <label for="cardType">Card type</label>
        <select id="cardType">
          <option value="surgery">Surgery</option>
          <option value="tech">Tech</option>
        </select>
      </div>

      <div class="field" data-section="surgery">
        <label for="surgStart">Surgery start time</label>
        <select id="surgStart"></select>
      </div>

      <div class="field" data-section="surgery">
        <label for="caseSpec">Specialty (optional)</label>
        <select id="caseSpec"></select>
      </div>

      <div class="field" data-section="surgery">
        <label for="caseSurgeonSelect">Surgeon (optional)</label>
        <select id="caseSurgeonSelect"></select>
      </div>

      <div class="field" id="surgeonOtherField" data-section="surgery" style="display:none;">
        <label for="caseSurgeonOther">Surgeon (Other)</label>
        <input id="caseSurgeonOther" type="text" placeholder="Type surgeon name" />
      </div>

      <div class="field" data-section="surgery">
        <label for="surgNotes">Notes (optional)</label>
        <textarea id="surgNotes" placeholder="Implants, trays, special equipment, etc."></textarea>
      </div>


      <div class="toggleRow" data-section="tech">
        <input id="useScrub" type="checkbox" checked />
        <label for="useScrub" style="cursor:pointer;color:var(--text);font-weight:800;">Include Scrub for this Tech card</label>
      </div>
      <div class="field" data-section="tech" data-scrub="1">
        <label for="scrubStart">Scrub start time</label>
        <select id="scrubStart"></select>
      </div>

      <div class="scrubList" data-section="tech" data-scrub="1">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div class="small" style="font-weight:800;color:var(--text);">Scrub Techs (multiple, optional)</div>
          <button class="smallBtn" id="addScrubBtn" type="button">+ Add Scrub Tech</button>
        </div>
        <div class="small" style="margin-top:-6px;">You can leave this empty and fill in later.</div>
        <div id="scrubRows"></div>
      </div>

      <div class="toggleRow" data-section="tech">
        <input id="useXray" type="checkbox" />
        <label for="useXray" style="cursor:pointer;color:var(--text);font-weight:800;">Include X-Ray for this Tech card</label>
      </div>

      <div class="field" data-section="tech" data-xray="1">
        <label for="xrayStart">X-Ray start time</label>
        <select id="xrayStart"></select>
      </div>

      <div class="field" data-section="tech" data-xray="1">
        <label for="caseXraySelect">X-Ray Tech</label>
        <select id="caseXraySelect"></select>
      </div>

      <div class="field" id="xrayOtherField" data-section="tech" data-xray="1" style="display:none;">
        <label for="caseXrayOther">X-Ray Tech (Other)</label>
        <input id="caseXrayOther" type="text" placeholder="Type x-ray tech name" />
      </div>

      <div class="field" data-section="tech">
        <label for="techNotes">Notes (optional)</label>
        <textarea id="techNotes" placeholder="Tech notes (optional)"></textarea>
      </div>
    </div>

    <div class="modalFoot">
      <div class="leftBtns">
        <button class="danger" id="deleteBtn" type="button" style="display:none;">Delete</button>
        <span class="small" id="saveStatus"></span>
      </div>
      <div class="rightBtns">
        <button class="ghost" id="cancelBtn" type="button">Cancel</button>
        <button class="primary" id="saveBtn" type="button">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  window.addEventListener('error', (e)=>{
    const banner = document.createElement('div');
    banner.style.position = 'fixed';
    banner.style.left = '12px';
    banner.style.right = '12px';
    banner.style.bottom = '12px';
    banner.style.zIndex = '9999';
    banner.style.padding = '10px 12px';
    banner.style.borderRadius = '12px';
    banner.style.background = 'rgba(255,107,107,.18)';
    banner.style.border = '1px solid rgba(255,107,107,.55)';
    banner.style.color = '#fff';
    banner.textContent = 'Scheduler error: ' + (e.message || 'Unknown error') + '. (Press F12 → Console for details)';
    document.body.appendChild(banner);
  });

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  const SURGEONS_BY_SPECIALTY = {
    orthopedic: ["Tyorkin","Bursztyn","Carrer","Baum","Wert","Goldman","Haimov","Stefanides","Corso","Winarsky","Rubinshteyn","Levine","Apazidis","Kramer","Syder","Bhansali"],
    pain: ["Shabtian","Apazidis","Portal","Agrawal","Shah","Wade","Pereira","Cherkalin","Resnick","Kaisman","Kooch","Phatare"],
    eyes: ["Weiss","Matta","Philips","Rabinovich"],
    podiatry: ["Sadhnani","Rosenblatt","Koslow","Adams","Mantalvo","Frank","Rotshteyn","Fayazalov","Esposito"],
    gyn: ["Syed"],
    ent: ["Branovan"]
  };

  const SPECIALTIES = [
    { id:"orthopedic", label:"Orthopedic", tintClass:"t-ortho" },
    { id:"pain", label:"Pain Management", tintClass:"t-pain" },
    { id:"eyes", label:"Eyes", tintClass:"t-eyes" },
    { id:"podiatry", label:"Podiatry", tintClass:"t-pods" },
    { id:"gyn", label:"GYN", tintClass:"t-gyn" },
    { id:"ent", label:"ENT", tintClass:"t-ent" },
    { id:"other", label:"Other", tintClass:"t-other" }
  ];

  const SCRUB_TECHS = ["Nikita","Katie","Cassandra","Marjana","Ellden","Parker","Artem","Madeline","Dmitri","Michelle N"];
  const XRAY_TECHS  = ["Arsen","Viorica"];
  const ALL_TECHS = Array.from(new Set([...SCRUB_TECHS, ...XRAY_TECHS]));

  const pad2 = n => String(n).padStart(2, "0");

  function hhmmToMinutes(str){
    const m = /^(\d{1,2}):(\d{2})$/.exec((str||"").trim());
    if(!m) return null;
    const h = +m[1], mm = +m[2];
    if(h<0||h>23||mm<0||mm>59) return null;
    return h*60+mm;
  }

  function minutesToAmPm(m){
    const h24 = Math.floor(m/60);
    const mm = m%60;
    const am = h24 < 12;
    let h = h24 % 12;
    if(h === 0) h = 12;
    return `${h}:${pad2(mm)} ${am ? "AM" : "PM"}`;
  }

  function makeTimeOptions(step=15, start="03:00", end="20:00"){
    const s = hhmmToMinutes(start), e = hhmmToMinutes(end);
    const out=[];
    for(let t=s; t<=e; t+=step) out.push({ minutes:t, label: minutesToAmPm(t) });
    return out;
  }

  function startOfWeekMonday(date){
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }

  const addDays = (date,n)=>{ const d=new Date(date); d.setDate(d.getDate()+n); return d; };
  const DAY_OFFSETS = [0,1,2,3,4,6]; // Mon–Fri + Sunday
  const isoDate = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const formatDate = d => d.toLocaleDateString(undefined,{weekday:"long",month:"short",day:"numeric"});
  const uid = ()=> Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

  function fillSelect(sel, items, getValue, getLabel){
    sel.innerHTML = "";
    for(const it of items){
      const opt = document.createElement("option");
      opt.value = getValue(it);
      opt.textContent = getLabel(it);
      sel.appendChild(opt);
    }
  }

  function toggleOtherField(selectEl, fieldEl, inputEl){
    if(selectEl.value === "Other (type)"){
      fieldEl.style.display = "block";
      setTimeout(()=> inputEl.focus(), 0);
    } else {
      fieldEl.style.display = "none";
    }
  }

  function getSpecialty(specId){
    if(!specId) return { id:"", label:"—", tintClass:"t-other" };
    return SPECIALTIES.find(s=>s.id===specId) || SPECIALTIES[SPECIALTIES.length-1];
  }

  const storageKey = weekIso => `asc-week-split-v4-${weekIso}`;

  function normalizeLoaded(data){
    const out = { cards: [] };
    const rawCards = (data && Array.isArray(data.cards)) ? data.cards :
                     (data && Array.isArray(data.cases)) ? data.cases : [];
    out.cards = rawCards.map(c=>{
      const type = c.type || c.cardType || "tech";
      if(type === "surgery"){
        return {
          id: c.id || uid(),
          type: "surgery",
          date: c.date,
          surgeryStart: Number.isFinite(c.surgeryStart) ? c.surgeryStart : (Number.isFinite(c.caseStart) ? c.caseStart : null),
          specialtyId: c.specialtyId || "",
          surgeonName: c.surgeonName || "—",
          notes: c.notes || ""
        };
      }
      return {
        id: c.id || uid(),
        type: "tech",
        date: c.date,
        scrubStart: Number.isFinite(c.scrubStart) ? c.scrubStart : null,
        scrubs: Array.isArray(c.scrubs) ? c.scrubs : [],
        useXray: (c.useXray !== undefined) ? !!c.useXray : (Number.isFinite(c.xrayStart) || (c.xray && c.xray !== "—")),
        xrayStart: Number.isFinite(c.xrayStart) ? c.xrayStart : null,
        xray: c.xray || "—",
        notes: c.notes || ""
      };
    });
    return out;
  }

  function loadWeek(weekIso){
    try{
      const raw = localStorage.getItem(storageKey(weekIso));
      if(!raw) return { cards: [] };
      return normalizeLoaded(JSON.parse(raw));
    }catch{
      return { cards: [] };
    }
  }
  function saveWeek(weekIso,data){
    localStorage.setItem(storageKey(weekIso), JSON.stringify(data));
  }

  const timeOptions = makeTimeOptions(15,"03:00","20:00");
  let weekStart = startOfWeekMonday(new Date());
  let model = loadWeek(isoDate(weekStart));
  let editingId = null;

  const gridEl = document.getElementById("grid");
  const weekSmallEl = document.getElementById("weekSmall");
  const captureArea = document.getElementById("captureArea");

  const prevWeekBtn = document.getElementById("prevWeekBtn");
  const nextWeekBtn = document.getElementById("nextWeekBtn");
  const todayWeekBtn = document.getElementById("todayWeekBtn");
  const copyPrevBtn = document.getElementById("copyPrevBtn");
  const exportPngBtn = document.getElementById("exportPngBtn");
  const printBtn = document.getElementById("printBtn");
  const clearWeekBtn = document.getElementById("clearWeekBtn");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const modalTitle = document.getElementById("modalTitle");
  const saveStatus = document.getElementById("saveStatus");

  const cardDay = document.getElementById("cardDay");
  const cardType = document.getElementById("cardType");

  const surgStart = document.getElementById("surgStart");
  const caseSpec = document.getElementById("caseSpec");
  const caseSurgeonSelect = document.getElementById("caseSurgeonSelect");
  const surgeonOtherField = document.getElementById("surgeonOtherField");
  const caseSurgeonOther = document.getElementById("caseSurgeonOther");
  const surgNotes = document.getElementById("surgNotes");

  const scrubStart = document.getElementById("scrubStart");
  const scrubRowsEl = document.getElementById("scrubRows");
  const addScrubBtn = document.getElementById("addScrubBtn");
  const useScrub = document.getElementById("useScrub");
  const useXray = document.getElementById("useXray");
  const xrayStart = document.getElementById("xrayStart");
  const caseXraySelect = document.getElementById("caseXraySelect");
  const xrayOtherField = document.getElementById("xrayOtherField");
  const caseXrayOther = document.getElementById("caseXrayOther");
  const techNotes = document.getElementById("techNotes");

  function persist(){
    saveWeek(isoDate(weekStart), model);
    saveStatus.textContent = "Saved locally.";
    setTimeout(()=> { if(saveStatus.textContent==="Saved locally.") saveStatus.textContent=""; }, 1200);
  }

  function weekLabel(){
    const end = addDays(weekStart,6);
    const opts = { month:"short", day:"numeric", year:"numeric" };
    return `${weekStart.toLocaleDateString(undefined, opts)} – ${end.toLocaleDateString(undefined, opts)}`;
  }

  function getSurgeonNameFromControls(){
    if(caseSurgeonSelect.value === "Other (type)") return (caseSurgeonOther.value||"").trim() || "—";
    return caseSurgeonSelect.value || "—";
  }
  function getXrayNameFromControls(){
    if(caseXraySelect.value === "Other (type)") return (caseXrayOther.value||"").trim() || "—";
    return caseXraySelect.value || "—";
  }

  function buildScrubRow(value){
    const row = document.createElement("div");
    row.className = "scrubRow";

    const sel = document.createElement("select");
    const opts = ["—", ...ALL_TECHS, "Other (type)"];
    fillSelect(sel, opts, s=>s, s=>s);
    sel.value = value && opts.includes(value) ? value : (value ? "Other (type)" : "—");

    const other = document.createElement("input");
    other.type = "text";
    other.placeholder = "Other scrub tech name";
    other.value = (value && !opts.includes(value) && value !== "—") ? value : "";
    other.style.display = (sel.value === "Other (type)") ? "block" : "none";

    sel.addEventListener("change", ()=>{
      if(sel.value === "Other (type)"){
        other.style.display = "block";
        setTimeout(()=> other.focus(), 0);
      } else {
        other.style.display = "none";
        other.value = "";
      }
    });

    const remove = document.createElement("button");
    remove.type = "button";
    remove.className = "removeBtn";
    remove.textContent = "–";
    remove.addEventListener("click", ()=> row.remove());

    row.appendChild(sel);
    row.appendChild(other);
    row.appendChild(remove);
    scrubRowsEl.appendChild(row);
  }

  function getScrubListFromUI(){
    const rows = Array.from(scrubRowsEl.querySelectorAll(".scrubRow"));
    const list = [];
    for(const r of rows){
      const sel = r.querySelector("select");
      const inp = r.querySelector("input");
      let name = "—";
      if(sel.value === "Other (type)") name = (inp.value || "").trim() || "—";
      else name = sel.value || "—";
      if(name !== "—") list.push(name);
    }
    const seen = new Set();
    const out = [];
    for(const n of list){
      const k = n.toLowerCase();
      if(!seen.has(k)){ seen.add(k); out.push(n); }
    }
    return out;
  }

  function setScrubListToUI(list){
    scrubRowsEl.innerHTML = "";
    const arr = Array.isArray(list) ? list : [];
    for(const n of arr) buildScrubRow(n);
  }
  addScrubBtn.addEventListener("click", ()=> buildScrubRow(""));

  function rebuildSurgeonDropdown(specId){
    const list = SURGEONS_BY_SPECIALTY[specId] || [];
    const opts = ["— (optional)", ...list, "Other (type)"];
    fillSelect(caseSurgeonSelect, opts, s=>s, s=>s);
    toggleOtherField(caseSurgeonSelect, surgeonOtherField, caseSurgeonOther);
  }
  caseSpec.addEventListener("change", ()=> rebuildSurgeonDropdown(caseSpec.value));
  caseSurgeonSelect.addEventListener("change", ()=> toggleOtherField(caseSurgeonSelect, surgeonOtherField, caseSurgeonOther));
  caseXraySelect.addEventListener("change", ()=> toggleOtherField(caseXraySelect, xrayOtherField, caseXrayOther));

  function applyModalVisibility(){
    const type = cardType.value;

    document.querySelectorAll("[data-section]").forEach(el=>{
      el.style.display = (el.getAttribute("data-section") === type) ? "" : "none";
    });

    // Scrub subsection
    const showScrub = (type === "tech" && useScrub && useScrub.checked);
    document.querySelectorAll('[data-scrub="1"]').forEach(el=>{
      el.style.display = showScrub ? "" : "none";
    });

    // X-ray subsection
    const showX = (type === "tech" && useXray.checked);
    document.querySelectorAll('[data-xray="1"]').forEach(el=>{
      el.style.display = showX ? "" : "none";
    });
  }
  cardType.addEventListener("change", applyModalVisibility);
  if(useScrub) useScrub.addEventListener("change", applyModalVisibility);
  useXray.addEventListener("change", applyModalVisibility);

  function buildModalDropdowns(){
    const days=[];
    for(const off of DAY_OFFSETS){
      const d=addDays(weekStart,off);
      days.push({ iso: isoDate(d), label: formatDate(d) });
    }
    fillSelect(cardDay, days, d=>d.iso, d=>d.label);

    fillSelect(scrubStart, timeOptions, t=>String(t.minutes), t=>t.label);
    fillSelect(surgStart, timeOptions, t=>String(t.minutes), t=>t.label);
    fillSelect(xrayStart, timeOptions, t=>String(t.minutes), t=>t.label);

    const specOpts = [{ id:"", label:"— (optional)", tintClass:"t-other" }, ...SPECIALTIES];
    fillSelect(caseSpec, specOpts, s=>s.id, s=>s.label);
    rebuildSurgeonDropdown(caseSpec.value);

    fillSelect(caseXraySelect, ["—", ...ALL_TECHS, "Other (type)"], s=>s, s=>s);
    toggleOtherField(caseXraySelect, xrayOtherField, caseXrayOther);
  }

  function sortSurgery(cards){
    return [...cards].sort((a,b)=>{
      const as = Number.isFinite(a.surgeryStart) ? a.surgeryStart : 99999;
      const bs = Number.isFinite(b.surgeryStart) ? b.surgeryStart : 99999;
      return as - bs;
    });
  }
  function sortTech(cards){
    return [...cards].sort((a,b)=>{
      const as = Number.isFinite(a.scrubStart) ? a.scrubStart : 99999;
      const bs = Number.isFinite(b.scrubStart) ? b.scrubStart : 99999;
      return as - bs;
    });
  }

  function render(){
    weekSmallEl.textContent = weekLabel();
    gridEl.innerHTML = "";

    for(const dayOff of DAY_OFFSETS){
      const d = addDays(weekStart, dayOff);
      const dayIso = isoDate(d);

      const dayCard = document.createElement("section");
      dayCard.className = "day";

      const header = document.createElement("div");
      header.className = "dayHeader";
      header.innerHTML = `
        <div>
          <h2>${d.toLocaleDateString(undefined,{weekday:"long"})}</h2>
          <div class="date">${d.toLocaleDateString(undefined,{month:"short", day:"numeric"})}</div>
        </div>
      `;

      const actions = document.createElement("div");
      actions.className = "dayActions";

      const addS = document.createElement("button");
      addS.className = "smallBtn pill";
      addS.type = "button";
      addS.textContent = "+ Surgery";
      addS.addEventListener("click", ()=> openModalForNew(dayIso, "surgery"));

      const addT = document.createElement("button");
      addT.className = "smallBtn pill";
      addT.type = "button";
      addT.textContent = "+ Tech";
      addT.addEventListener("click", ()=> openModalForNew(dayIso, "tech"));

      actions.appendChild(addS);
      actions.appendChild(addT);
      header.appendChild(actions);

      dayCard.appendChild(header);

      const body = document.createElement("div");
      body.className = "dayBody";

      const laneS = document.createElement("div");
      laneS.className = "lane";
      laneS.innerHTML = `
        <div class="laneHead"><div class="laneTitle">SURGERY</div></div>
        <div class="cases" id="s-${dayIso}"></div>
      `;

      const laneT = document.createElement("div");
      laneT.className = "lane";
      laneT.innerHTML = `
        <div class="laneHead"><div class="laneTitle">TECH</div></div>
        <div class="cases" id="t-${dayIso}"></div>
      `;

      body.appendChild(laneS);
      body.appendChild(laneT);
      dayCard.appendChild(body);
      gridEl.appendChild(dayCard);

      const surgeryCards = sortSurgery(model.cards.filter(c=>c.date===dayIso && c.type==="surgery"));
      const techCards = sortTech(model.cards.filter(c=>c.date===dayIso && c.type==="tech"));

      const sWrap = document.getElementById(`s-${dayIso}`);
      const tWrap = document.getElementById(`t-${dayIso}`);

      if(surgeryCards.length === 0){
        const empty = document.createElement("div");
        empty.className = "small";
        empty.textContent = "No surgery cards";
        sWrap.appendChild(empty);
      } else {
        for(const c of surgeryCards){
          const spec = getSpecialty(c.specialtyId);
          const time = Number.isFinite(c.surgeryStart) ? minutesToAmPm(c.surgeryStart) : "—";
          const surgeon = (c.surgeonName && c.surgeonName.trim()) ? c.surgeonName.trim() : "—";
          const specLabel = (spec.label && spec.label !== "—") ? spec.label : "—";

          const card = document.createElement("article");
          card.className = `caseCard ${spec.tintClass || "t-other"}`;
          card.tabIndex = 0;

          let lineParts = [];
          if(specLabel !== "—") lineParts.push(specLabel);
          if(surgeon !== "—" && surgeon !== "— (optional)") lineParts.push(surgeon);
          const line = lineParts.join(" • ");

          card.innerHTML = `
            <div class="timeStack">
              <div class="timePill">
                <div class="timeTop">
                  <div class="label">Surgery start</div>
                  <div class="val">${escapeHtml(time)}</div>
                </div>
                ${line ? `<div class="physLine">${escapeHtml(line)}</div>` : `<div class="physLine">—</div>`}
              </div>
              <div class="specTag" style="align-self:flex-start;">${escapeHtml(specLabel)}</div>
            </div>
            ${c.notes && c.notes.trim() ? `<div class="small">Notes: ${escapeHtml(c.notes.trim())}</div>` : ""}
          `;

card.addEventListener("click", ()=> openModalForEdit(c.id));
          card.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openModalForEdit(c.id);} });
          sWrap.appendChild(card);
        }
      }

      if(techCards.length === 0){
        const empty = document.createElement("div");
        empty.className = "small";
        empty.textContent = "No tech cards";
        tWrap.appendChild(empty);
      } else {
        for(const c of techCards){
          const showScrub = !!(Number.isFinite(c.scrubStart) || (Array.isArray(c.scrubs) && c.scrubs.length));
          const scrubTime = showScrub && Number.isFinite(c.scrubStart) ? minutesToAmPm(c.scrubStart) : "—";
          const scrubText = showScrub && (Array.isArray(c.scrubs) && c.scrubs.length) ? c.scrubs.join(", ") : "—";

          const showX = !!c.useXray;
          const xTime = (showX && Number.isFinite(c.xrayStart)) ? minutesToAmPm(c.xrayStart) : "—";
          const xName = (showX && c.xray && c.xray !== "—") ? c.xray : "—";

          const card = document.createElement("article");
          card.className = "caseCard t-other";
          card.tabIndex = 0;

          card.innerHTML = `
            <div class="timeStack">
              ${showScrub ? `
              <div class="timePill">
                <div class="timeTop">
                  <div class="label">Scrub start</div>
                  <div class="val">${escapeHtml(scrubTime)}</div>
                </div>
                <div class="sub">${escapeHtml(scrubText)}</div>
              </div>` : ``}

              ${showX ? `
              <div class="timePill xray">
                <div class="timeTop">
                  <div class="label">X-Ray start</div>
                  <div class="val">${escapeHtml(xTime)}</div>
                </div>
                <div class="sub">${escapeHtml(xName)}</div>
              </div>` : ``}

              ${c.notes && c.notes.trim() ? `<div class="small">Notes: ${escapeHtml(c.notes.trim())}</div>` : ""}
            </div>
          `;

          card.addEventListener("click", ()=> openModalForEdit(c.id));
          card.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openModalForEdit(c.id);} });
          tWrap.appendChild(card);
        }
      }
    }
  }

  function openModal(){
    saveStatus.textContent = "";
    modalBackdrop.classList.add("open");
    setTimeout(()=> cardDay.focus(), 0);
  }
  function closeModal(){
    modalBackdrop.classList.remove("open");
    editingId = null;
  }

  function openModalForNew(dayIso, type){
    editingId = null;
    buildModalDropdowns();
    deleteBtn.style.display = "none";
    modalTitle.textContent = type === "surgery" ? "Add Surgery Card" : "Add Tech Card";

    cardDay.value = dayIso;
    cardType.value = type;

    surgStart.value = String(hhmmToMinutes("07:00"));
    scrubStart.value = String(hhmmToMinutes("07:00"));

    caseSpec.value = "";
    rebuildSurgeonDropdown(caseSpec.value);
    caseSurgeonSelect.value = "— (optional)";
    caseSurgeonOther.value = "";
    surgeonOtherField.style.display = "none";
    surgNotes.value = "";

    scrubRowsEl.innerHTML = "";
    if(useScrub) useScrub.checked = true;
    useXray.checked = false;
    xrayStart.value = String(hhmmToMinutes("07:00"));
    caseXraySelect.value = "—";
    caseXrayOther.value = "";
    xrayOtherField.style.display = "none";
    techNotes.value = "";

    applyModalVisibility();
    openModal();
  }

  function openModalForEdit(id){
    const c = model.cards.find(x=>x.id===id);
    if(!c) return;

    editingId = id;
    buildModalDropdowns();
    deleteBtn.style.display = "inline-block";

    cardDay.value = c.date;
    cardType.value = c.type;

    if(c.type === "surgery"){
      modalTitle.textContent = "Edit Surgery Card";
      surgStart.value = String(Number.isFinite(c.surgeryStart) ? c.surgeryStart : hhmmToMinutes("07:00"));
      caseSpec.value = c.specialtyId || "";
      rebuildSurgeonDropdown(caseSpec.value);

      const surgeonName = (c.surgeonName || "").trim();
      const opts = Array.from(caseSurgeonSelect.options).map(o=>o.value);
      if(!surgeonName || surgeonName === "—"){
        caseSurgeonSelect.value = "— (optional)";
        surgeonOtherField.style.display = "none";
        caseSurgeonOther.value = "";
      } else if(opts.includes(surgeonName)){
        caseSurgeonSelect.value = surgeonName;
        surgeonOtherField.style.display = "none";
        caseSurgeonOther.value = "";
      } else {
        caseSurgeonSelect.value = "Other (type)";
        surgeonOtherField.style.display = "block";
        caseSurgeonOther.value = surgeonName;
      }

      surgNotes.value = c.notes || "";
    } else {
      modalTitle.textContent = "Edit Tech Card";
      scrubStart.value = String(Number.isFinite(c.scrubStart) ? c.scrubStart : hhmmToMinutes("07:00"));
      setScrubListToUI(Array.isArray(c.scrubs) ? c.scrubs : []);
      if(useScrub) useScrub.checked = !!(Number.isFinite(c.scrubStart) || (Array.isArray(c.scrubs) && c.scrubs.length));
      useXray.checked = !!c.useXray;

      xrayStart.value = String(Number.isFinite(c.xrayStart) ? c.xrayStart : hhmmToMinutes("07:00"));
      const xName = (c.xray || "—").trim();
      const xOpts = Array.from(caseXraySelect.options).map(o=>o.value);
      if(!xName || xName === "—"){
        caseXraySelect.value = "—";
        xrayOtherField.style.display = "none";
        caseXrayOther.value = "";
      } else if(xOpts.includes(xName)){
        caseXraySelect.value = xName;
        xrayOtherField.style.display = "none";
        caseXrayOther.value = "";
      } else {
        caseXraySelect.value = "Other (type)";
        xrayOtherField.style.display = "block";
        caseXrayOther.value = xName;
      }

      techNotes.value = c.notes || "";
    }

    applyModalVisibility();
    openModal();
  }

  function saveFromModal(){
    const date = cardDay.value;
    const type = cardType.value;

    if(!date){
      saveStatus.textContent = "Please select day.";
      return;
    }

    if(type === "surgery"){
      const sTime = Number(surgStart.value);
      if(!Number.isFinite(sTime)){
        saveStatus.textContent = "Please select surgery start time.";
        return;
      }

      const surgeon = getSurgeonNameFromControls();
      const payload = {
        id: editingId || uid(),
        type: "surgery",
        date,
        surgeryStart: sTime,
        specialtyId: caseSpec.value || "",
        surgeonName: (surgeon === "— (optional)") ? "—" : surgeon,
        notes: surgNotes.value || ""
      };

      if(editingId){
        const idx = model.cards.findIndex(x=>x.id===editingId);
        if(idx>=0) model.cards[idx] = payload;
      } else {
        model.cards.push(payload);
      }

      persist(); render(); closeModal();
      return;
    }

    const includeScrub = !!(useScrub && useScrub.checked);
    const includeX = !!useXray.checked;

    if(!includeScrub && !includeX){
      saveStatus.textContent = "Please include Scrub and/or X-Ray for this Tech card.";
      return;
    }

    let sScrub = null;
    let scrubs = [];
    if(includeScrub){
      const v = Number(scrubStart.value);
      if(!Number.isFinite(v)){
        saveStatus.textContent = "Please select scrub start time.";
        return;
      }
      sScrub = v;
      scrubs = getScrubListFromUI();
    }

    let xStartVal = null;
    let xNameVal = "—";
    if(includeX){
      const xs = Number(xrayStart.value);
      if(!Number.isFinite(xs)){
        saveStatus.textContent = "Please select X-Ray start time.";
        return;
      }
      xStartVal = xs;
      xNameVal = getXrayNameFromControls() || "—";
      if(xNameVal === "") xNameVal = "—";
    }

    const payload = {
      id: editingId || uid(),
      type: "tech",
      date,
      scrubStart: includeScrub ? sScrub : null,
      scrubs: includeScrub ? scrubs : [],
      useXray: includeX,
      xrayStart: includeX ? xStartVal : null,
      xray: includeX ? xNameVal : "—",
      notes: techNotes.value || ""
    };

    if(editingId){
      const idx = model.cards.findIndex(x=>x.id===editingId);
      if(idx>=0) model.cards[idx] = payload;
    } else {
      model.cards.push(payload);
    }

    persist(); render(); closeModal();
  }

  function deleteFromModal(){
    if(!editingId) return;
    model.cards = model.cards.filter(x=>x.id!==editingId);
    persist(); render(); closeModal();
  }

  function copyPreviousWeekIntoThisWeek(){
    const prevWeekStart = addDays(weekStart, -7);
    const prev = loadWeek(isoDate(prevWeekStart));
    const prevCards = (prev && Array.isArray(prev.cards)) ? prev.cards : [];
    if(prevCards.length === 0){
      alert("No cards found in the previous week to copy.");
      return;
    }
    const ok = confirm("Copy ALL cards from last week into this week?\n\nThis will OVERWRITE the current week.");
    if(!ok) return;

    const shifted = prevCards.map(c=>({
      ...c,
      id: uid(),
      date: isoDate(addDays(new Date(c.date + "T00:00:00"), 7))
    }));

    model = { cards: shifted };
    saveWeek(isoDate(weekStart), model);
    render();
    alert("Copied previous week into this week.");
  }

  async function exportPngScreenshot(){
    if(modalBackdrop.classList.contains("open")) closeModal();

    const node = captureArea;
    const clone = node.cloneNode(true);
    clone.style.margin = "0";
    clone.style.padding = "0";

    const wrapper = document.createElement("div");
    wrapper.style.background = getComputedStyle(document.body).backgroundColor || "#0b1220";
    wrapper.style.padding = "12px";
    wrapper.appendChild(clone);

    const w = node.getBoundingClientRect().width;
    const h = node.getBoundingClientRect().height;

    const serializer = new XMLSerializer();
    const html = serializer.serializeToString(wrapper);

    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${Math.ceil(w+24)}" height="${Math.ceil(h+24)}">
        <foreignObject width="100%" height="100%">
          <div xmlns="http://www.w3.org/1999/xhtml">${html}</div>
        </foreignObject>
      </svg>
    `;

    const svgBlob = new Blob([svg], {type: "image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(svgBlob);

    try{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = url;
      await new Promise((res, rej)=>{
        img.onload = ()=>res();
        img.onerror = ()=>rej(new Error("Image load failed"));
      });

      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);

      canvas.toBlob((blob)=>{
        if(!blob){
          alert("PNG export was blocked or failed in this browser. Use Print / Save PDF instead.");
          return;
        }
        const a = document.createElement("a");
        const week = isoDate(weekStart);
        a.download = `ASC_Schedule_${week}.png`;
        a.href = URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
      }, "image/png");
    }catch(err){
      alert("PNG export was blocked or failed in this browser. Use Print / Save PDF instead.");
    } finally {
      URL.revokeObjectURL(url);
    }
  }

  function loadCurrentWeek(){
    model = loadWeek(isoDate(weekStart));
    render();
  }

  prevWeekBtn.addEventListener("click", ()=>{ weekStart = addDays(weekStart, -7); loadCurrentWeek(); });
  nextWeekBtn.addEventListener("click", ()=>{ weekStart = addDays(weekStart,  7); loadCurrentWeek(); });
  todayWeekBtn.addEventListener("click", ()=>{ weekStart = startOfWeekMonday(new Date()); loadCurrentWeek(); });

  copyPrevBtn.addEventListener("click", copyPreviousWeekIntoThisWeek);
  exportPngBtn.addEventListener("click", exportPngScreenshot);
  printBtn.addEventListener("click", ()=> window.print());
  clearWeekBtn.addEventListener("click", ()=>{
    const wk = isoDate(weekStart);
    if(!confirm(`Clear ALL cards for week starting ${wk}?`)) return;
    localStorage.removeItem(storageKey(wk));
    model = { cards: [] };
    render();
  });

  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  saveBtn.addEventListener("click", saveFromModal);
  deleteBtn.addEventListener("click", deleteFromModal);

  modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if(modalBackdrop.classList.contains("open") && e.key === "Escape") closeModal(); });

  buildModalDropdowns();
  applyModalVisibility();
  render();
})();
</script>

<script>
/* === CARD TAP TO COLLAPSE / EXPAND === */
document.addEventListener("click", function(e) {
  const card = e.target.closest(".caseCard");
  if (!card) return;

  // Prevent conflict with modal open buttons
  if (e.target.closest("button")) return;

  if (card.classList.contains("collapsed")) {
    card.classList.remove("collapsed");
  } else {
    card.classList.add("collapsed");
  }
});
</script>

</body>
</html>
